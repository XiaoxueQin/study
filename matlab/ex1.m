n=5;
mu=10*n;
syms h;
h=1/n;
f=zeros(n,1);
B=zeros(n);
%right side
f(1)= quad(@(x)(-1/h*(x-0.5*h)+1).*cos(pi*x),0,h)+...
     quad(@(x)(-0.5/h*(x-1.5*h)+1/3).*cos(pi*x),h,2*h);
f(2)=quad(@(x) ( 1/h*(x-0.5*h)).*cos(pi*x),0,h)+...
     quad(@(x) (-0.5/h*(x-2.5*h)+1/3).*cos(pi*x),2*h,3*h)+...
     quad(@(x) 1/3*cos(pi*x),h,2*h);
for i=3:n-2
   f(i)=  quad(@(x) ( 0.5/h*(x-(i-1.5)*h)+1/3).*cos(pi*x),(i-2)*h,(i-1)*h)+...
    quad(@(x) ( -0.5/h*(x-(i+0.5)*h)+1/3).*cos(pi*x),i*h,(i+1)*h)+...
    quad(@(x) 1/3*cos(pi*x),(i-1)*h,i*h);
end
f(n-1)= quad(@(x) ( 0.5/h*(x-(n-2.5)*h)+1/3).*cos(pi*x),(n-3)*h,(n-2)*h)+...
     quad(@(x) ( -1/h*(x-(n-0.5)*h)).*cos(pi*x),(n-1)*h,n*h)+...
     quad(@(x) 1/3*cos(pi*x),(n-2)*h,(n-1)*h);
f(n)=quad(@(x)(0.5/h*(x-(n-1.5)*h)+1/3).*cos(pi*x),(n-2)*h,(n-1)*h)+...
    quad(@(x)(1/h*(x-(n-0.5)*h)+1).*cos(pi*x),(n-1)*h,n*h);
f2=pi^2.*f;
B(1,1)=5/(4*h)-...
    2*(1/2-1/4-1/3)*(-3/(4*h))-...
    2*(-1/4+1/3)*0.5*(-0.5/h)+...
    mu*(1/2-1/4-1/3)^2+...
    mu*(-1/4+1/3)^2;
B(2,2)= 5/(4*h)-...
    2*(1/2-1/3)*(1/(2*h))-...
    2*(-1/4+1/3)*(-1/(4*h))-...
    2*(-1/4)*(-1/(4*h))+...
    mu*(1/2-1/3)^2+...
    mu*(-1/4)^2+...
    mu*(-1/4+1/3)^2;
        
for i=3:n-2
    B(i,i)=1/(2*h)-...
        2*(1/4-1/3)*(1/(4*h))-...
        2*(1/4)*(1/(4*h))-...
        2*(-1/4+1/3)*(-1/(4*h))-...
        2*(-1/4)*(-1/(4*h))+...
        mu*(1/4-1/3)^2+...
        mu*(1/4)^2+...
        mu*(-1/4+1/3)^2+...
        mu*(-1/4)^2;
end

B(n-1,n-1)= 5/(4*h)-...
    2*(1/4-1/3)*(1/(4*h))-...
    2*(1/4)*(1/(4*h))-...
    2*(1/3-1/2)*(-1/(2*h))+...
    mu*(1/4-1/3)^2+...
    mu*(1/4)^2+...
    mu*(-1/2+1/3)^2;

B(n,n)=5/(4*h)-...
    2*(1/4-1/3)*1/(4*h)-...
    2*(1/4+1/3-1/2)*(3/(4*h))+...
    mu*(1/4-1/3)^2+...
    mu*(1/4+1/3-1/2)^2;

%one point overlap 
for i=1:n
    for j=1:n
        if(i-j==3)
            B(i,j)=-(1/4-1/3)*(-1/(4*h))-(1/3-1/4)*(1/(4*h))+...
                mu*(1/4-1/3)*(1/3-1/4);
            B(j,i)=B(i,j);
        end
    end
end

%two points overlap
for i=2:n-1
    for j=2:n-1
        if(i-j==2)
            B(i,j)=-1/(4*h)-...
                (-1/4*1/(4*h))-(1/4-1/3)*(-1/(4*h))-...
                (1/3-1/4)/(4*h)-1/4*(-1/(4*h))+...
                mu*(-1/4*(1/4-1/3))+mu*(-1/4+1/3)*1/4;
            B(j,i)=B(i,j);
        end
                
    end
end

B(1,3)=-1/(4*h)-...
    (1/2-1/3-1/4)/(4*h)-(1/4-1/3)*(-3/(4*h))-...
    (1/3-1/4)/(4*h)-1/4*(-1/(4*h))+...
    mu*((1/2-1/3-1/4)*(1/4-1/3))+mu*(-1/4+1/3)*1/4;
B(3,1)=B(1,3);
B(n-2,n)=-1/(4*h)-...
    (1/3-1/4)/(4*h)+1/4*(1/(4*h))-...
    (1/2-1/3-1/4)/(4*h)-(1/3-1/4)*(3/(4*h))+...
    mu*((1/2-1/3-1/4)*(1/4-1/3))+mu*(-1/4+1/3)*1/4;
B(n,n-2)=B(n-2,n);

%three points overlap

for i=3:n-2
    for j=3:n-2
        if(i-j==1)
            B(i,j)=-(1/4)/(1/(4*h))-(1/4-1/3)/(4*h)-...
                1/4/(-4*h)-(-1/4)*(1/(4*h))-...
                (-1/4)*(-1/(4*h))-(1/3-1/4)/(-4*h)+...
                mu*(1/4-1/3)/4+mu*(-1/16)+mu*(-1/4)*(1/3-1/4);
            
            B(j,i)=B(i,j);
        end
    end
end

B(1,2)=-1/h-...
    (1/2-1/3-1/4)/(2*h)-(1/2-1/3)*(-3/(4*h))-...
    (1/3-1/4)/(-4*h)-(1/(16*h))+...
    mu*(1/2-1/3-1/4)*(1/2-1/3)+mu*(1/3-1/4)/(-4);

B(2,1)=B(1,2);
B(n-1,n)=B(1,2);
B(n,n-1)=B(1,2);

B(2,3)=-(1/2-1/3)/(4*h)-(1/4-1/3)/(2*h)-...
    (-1/4)/(4*h)-(-1/(16*h))-...
    (1/3-1/4)/(-4*h)-(1/(16*h))+...
    mu*(1/2-1/3)*(1/4-1/3)+mu*(-1/16)+mu*(1/3-1/4)/(-4);

B(3,2)=B(2,3);
B(n-2,n-1)=B(2,3);
B(n-1,n-2)=B(2,3);
x=0.5*h:h:(1-0.5*h);
y1=cos(pi*x);
y=B\f2;
plot(x,y1)
err=norm(y-y1')/norm(y1)